## 局部性和快速文件系统

第一个文件系统：超级块（S）包含有关整个文件系统的信息：卷的大小、有多少 inode、指向空闲列表块的头部的指针等等

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-17_11-31-33.png)



## 问题：性能不佳

- 老 UNIX 文件系统将磁盘当成随机存取内存。具有实实在在的、昂贵的定位成本
- 文件系统最终会变得**非常碎片化**（fragmented），因为空闲空间没有得到精心管理。这个碎片问题一直发生在老UNIX 文件系统中，并且会影响性能
- 原始块大小太小。每个块可能需要一个定位开销来访问它，因此传输不佳

## FFS：磁盘意识是解决方案

**快速文件系统**（Fast File System，FFS）

**思路：**文件系统的结构和分配策略具有“磁盘意识”



## 组织结构：柱面组

**区别:**FFS 将磁盘划分为一些分组，称为**柱面组**（cylinder group，而一些现代文件系统，如 Linux ext2 和 ext3，就称它们为**块组**,即 block group

**柱面组:**

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-17_11-35-07.png)

- 每个组中都有超级块（super block）的一个副本
- 我们需要记录该组的 inode 和数据块是否已分配。每组的 inode 位图（inode bitmap，ib）和数据位图（data bitmap，db）起到了这个作用)
- inode 和数据块区域就像之前的极简文件系统一样。像往常一样，每个柱面组的大部分都包含数据块。



## 策略：如何分配文件和目录 

**策略：**相关的东西放一起

- 目录放置
  - 找到分配数量少的柱面组和大量的自由inode，并将目录数据
     和 inode 放在该分组中
- 对于文件。（两件事）
  - 首先，它确保（在一般情况下）将文件的数据块分配到与其inode 相同的组中，从而防止 inode 和数据之间的长时间寻道
  - 它将位于同一目录中的所有文件，放在它们所在目录的柱面组



## 测量文件的局部性 

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-17_11-43-11.png)

你可以看到大约 7%的文件访问是先前打开的文件，并且近 40%的文件访问是相同的文件或同一目录中的文件

因此，FFS的局部性假设似乎有意



## 大文件例外

**摊销:**如果大块大小足够大，我们大部分时间仍然花在从磁盘传输数据上，而在大块之间寻道的时间相对较少



## 关于 FFS 的其他几件事 

**针对小文件的问题**

**解决方案：**

- 他们决定**引入子块**(sub-block), 这些子块有 512 字节，文件系统可以将它们分配给文件.但同时发现这个过程效率低下，文件系统需要大量的额外工作
- **解决：**
  - FFS 通常通过修改 libc 库来避免这种异常行为。该库将缓冲写入，然后以 4KB 块的形式将它们发送到文件系统，从而在大多数情况下完全避免子块的特殊情况。

- FFS 引入的第二个巧妙方法，是针对性能进行优化的磁盘布局。需要主机 CPU 以更加亲力亲为的方式来控制它们的操作

