# 磁盘驱动器

**关键问题：如何存储和访问磁盘上的数据**

> 现代磁盘驱动器如何存储数据？接口是什么？数据是如何安排和访问的？磁盘调度如何提高性能？



## 接口

- 现代磁盘驱动器的接口。所有现代驱动器的基本接口都很简单
- 驱动器由大量扇区（512 字节块）组成，每个扇区都可以读取或写入



## 基本几何形状

- **盘片：**它是一个圆形坚硬的表面，通过引入磁性变化来永久存储数据。每个盘片有两面，每面称为表面。盘片通常由一些硬质材料（如铝）制成，然后涂上薄薄的磁性层，即使驱动器断电，驱动器也能持久存储数据位。
- 盘片都围绕主轴。主轴连接到一个电机，以一个恒定（固定）的速度旋转盘片

- 数据在扇区的同心圆中的每个表面上被编码。这样的同心圆为一个磁道（track）。

- 读写过程由磁头（disk head）完成。驱动器的每个表面有一个这样的磁头。磁头连接到单个磁盘臂（disk arm）上，磁盘臂在表面上移动，将磁头定位在期望的磁道上。



## 简单的磁盘驱动器

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-15_11-51-18.png)

- 该磁道只有 12 个扇区，每个扇区的大小为 512 字节
- 这里的单个盘片围绕主轴旋转，电机连接到主轴

### 单磁道延迟：旋转延迟

**旋转延迟：**它必须等待期望的扇区旋转到磁头下。

例子：（如果我们从 6 开始）。对这个单一磁道，最坏情况的请求是第5扇

区，这导致接近完整的旋转延迟，才能服务这种请求。

### 多磁道：寻道时间

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-15_11-55-01.png)

<u>寻道，以及旋转，是最昂贵的磁盘操作之一</u>

**寻道阶段：**

- 首先是磁盘臂移动时的加速阶段
- 然后随着磁盘臂全速移动而惯性滑动。然后随着磁盘臂减速而减速。
- 最后，在磁头小心地放置在正确的磁道上时停下来
- 停放时间（settling time）通常不小，例如 0.5～2ms
- 当扇区 11 经过磁盘磁头时，I/O 的最后阶段将发生，称为传输（transfer），数据从表面读取或写入表面

### 一些其他细节

**磁道偏斜：**扇区往往会偏斜，因为从一个磁道切换到另一个磁道时，磁盘需要时间来重新定位磁头（即便移到相邻磁道）。**如果没有这种偏斜**，磁头将移动到下一个磁道，但所需的下一个块已经旋转到磁头下，因此**驱动器将不得不等待整个旋转延迟，才能访问下一个块**

- 任何磁盘驱动器都有一个重要组成部分——磁盘缓冲器（tracker buffer）。该缓存只有少量的内存（8MB 或者 16MB）



## I/O时间

**I/O时间：** 下标

T~I/O~ = T~寻道~ + T~旋转~  + T~传输~

```
TI/O时间 = T寻道 + T旋转 + T传输 
```

**I/O速率：**它很容易从时间计算出来。只要将传输的大小除以所花的时间：

公式:`R~IO~ = 大小~传输~ /T~IO~`

**考虑负载：**

- 随机负载：磁盘上的随机位置发出小的（例如 4KB）读取请求
- 顺序负载：只是从磁盘连续读取大量的扇区，不会跳过



## 磁盘调度

### SSTF:最短时间优先

最短寻道时间优先（Shortest-Seek-Time-First，SSTF），<u>选择在最近磁道上的请求先完成。</u>

**缺点：**

- 一个问题，主机操作系统无法利用驱动器的几何结构，而是只会看到一系列的块
- 第二个根本问题：饥饿

**关键问题：如何处理磁盘饥饿**

> 我们如何实现类 SSTF 调度，但避免饥饿？
>
> **电梯解决**



### 电梯（又称 SCAN 或 C-SCAN） 

**原理:**算法最初称为 SCAN，简单地以跨越磁道的顺序来服务磁盘请求.将一次跨越磁盘称为扫一遍.如果请求的块所属的磁道在这次扫一遍中已经服务过了，它就不会立即处理，而是排队等待下次扫一遍.

**关键问题：如何计算磁盘旋转开销**

> 如何同时考虑寻道和旋转，实现更接近 SJF 的算法？



### SPTF：最短定位时间优先

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-15_12-23-40.png)

**例子：**磁头当前定位在内圈磁道上的扇区 30上方。因此，调度程序必须决定：下一个请求应该为安排扇区 16（在中间磁道上）还是扇区 8（在外圈磁道上）。接下来应该服务哪个请求？

**答案：**答案是“视情况而定”。



### 其他调度问题

- 在现代系统上执行磁盘调度的地方在哪里
- 磁盘调度程序执行的另一个重要相关任务是 I/O 合并



## 作业

**转换问题：**

在`python2`，/只留下了整数部分，去掉了小数，是int型。
在`python3`里，/的结果是真正意义上的除法，结果是float型。所以便出现了

`Error Message: ‘float’ object cannot be interpreted as an integer。`

**在`python3`中用双//就可以了**

