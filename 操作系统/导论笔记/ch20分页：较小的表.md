# 分页：较小的表

**关键问题：如何页表更小**

> 简单的基于数组的页表（通常称为线性页表）太大，在典型系统上占用太多内存。如何让页表更小？关键的思路是什么？由于这些新的数据结构，会出现什么效率影响？

## 简单决解方案：更大的页

**减小页表大小：使用更大页。**

- **问题： ** **内部碎片**的产生——大内存会导致每页的浪费
- 采用相对较小的页大小：`4KB(X86)`, `8KB(SPARCv9)`

## 混合方法：分页和分段

**混合方法：** 不是为进程的整个地址空间提供单个页表，而是为每个**逻辑分段提供一个。**

- 基址寄存器、界限寄存器的使用
  - 我们使用基址不是指向段本身，而是**保存该段的页表的物理地址**。界限寄存器用于指示**页表的结尾**
- 杂关键区别在于，每个分段都有界限寄存器，每个界限寄存器保存了段中最大有效页的值。

## 多级页表

不依赖分段，但也可以**解决相同问题：**如何去掉页表中的所有无效
区域，而不是将它们全部保留在内存中

**多级页表：** <u>将线性页表变成了类似树的东西</u>。这种方法非常有效，许多现代系统都用它

**基本思想：** **将页表分成页大小的单元**。然后，如果整页的页表项（`PTE`）无效，就完全不分配该页的页表。**为了追踪页表的页是否有效（以及如果有效，它在内存中的位置），使用了名为页目录（page directory）的新结构**。页目录因此可以告诉你**页表的页在哪里，或者页表的整个页不包含有效页**

**工作方式：** 它只是让线性页表的一部分消失（释放这些帧用于其他用途），并用页目录来**记录页表的哪些页被分配**

**二级页表页目录：** 它由多个页目录项（`Page Directory Entries，PDE`）组成。`PDE`（至少）拥有有效位（valid bit）和页帧号（page frame number，`PFN`），类似`PTE`

- 持有效位的含义不同：如果 `PDE` 项是有效的，则意味着该项指向的页表（通过 `PFN`）中至少有一页是有效的，即在该 `PDE` 所指向的页中，至少一个 `PTE`，其有效位被设置为 1。如果 `PDE` 项无效（即等于零），则 `PDE`的其余部分没有定义

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-04_10-35-24.png)



**多级页表成本：** 多级页表是有成本的。在 `TLB` 未命中时，需要从内存加载两次，才能从页表中获取正确的地址转换信息（一次用于页目录，另一次用于 `PTE` 本身），而线性页表只需要加载一次。因此**多级页表是一个时间-空间这种小例子**



**例子**....



## 反向页表

反向页表（inverted page table）中，可以看到页表世界中更极端的空间节省



## 将页表交换到磁盘中

<u>页表放入内核虚拟内存（kernel virtual memory），从而允许系统在内存压力较大时，将这些页表中的一部分交换（swap）到磁盘</u>



## 英语名词

- 页目录项（`Page Directory Entries，PDE`)
- 虚拟页面号(virtual page number, `VPN`)
- **物理帧**（`PFN\PPN`，physical page number）
- 页表项（`PTE`）
- 快速地址转换（`TLB`）
- **地址空间标识符**（Address Space Identifier，`ASID`）。