# 数据完整性和保护

**关键问题：如何确保数据完整性新**

> 系统应如何确保写入存储的数据受到保护？需要什么技术？如何在低空间和时间开销的情况下提高这些技术的效率？



## 磁盘故障模式

两种类型的单块故障模式

- 潜在扇区错误
- 块讹误

**磁盘内纠错码：**确定块中的磁盘位是否良好，并且在某些情况下，修复它们。——**针对块讹误**

## 处理潜在扇区错误

**关键问题：如何处理潜在的扇区错误**

> 存储系统应该如何处理潜在的扇区错误？需要多少额外的机制来处理这种形式的部分故障？

潜在的扇区错误很**容易处理**，因为它们（根据定义）很容易被检测到.当存储系统尝试访问块，并且磁盘返回错误时，存储系统应该就用它具有的任何冗余机制，来返回正确的数据.

针对重建无法成功完成的，系统<u>增加额外的冗余度</u>



## 检测讹误：校验和

**关键问题：尽管有讹误，如何保护数据完整性**

> 鉴于此类故障的无声性，存储系统可以做些什么来检测何时出现讹误？需要什么技术？如何有效地实现？

**校验和：**校验和就是一个函数的结果，该函数以一块数据（例如 4KB 块）作为输入，并计算这段数据的函数，产生数据内容的小概要（比如 4 字节或 8 字节）。此摘要称为校验和



### 常见校验和函数

- 基于异或
- Fletcher 校验和。涉及两个校验字节 s1 和 s2 的计算
- 循环冗余校验（CRC）。算数据块 D 的校验和。你所做的只是将 D 视为一个大的二进制数（毕竟它只是一串位）并将其除以约定的值（k）。该**除法的其余部分**是 CRC 的值。

### 校验和布局

分析如何在存储系统中使用校验和？？？

- 校验和通常很小（例如，8 字节），并且磁盘只能以扇区大小的块（512 字节）或
   其倍数写入。
- 驱动器制造商采用的一种解决方案是使用 520 字节扇区格式化驱动器，每个扇区额外的 8 个字节可用于存储校验和



## 使用校验和

- 存储的校验和：读取块 D 时，客户端（即文件系统或存储控制器）也从磁盘 Cs（D）读取其校验和。
- 计算的校验和：客户端计算读取的块 D 上的校验和



## 错误的写入

**关键问题：如何处理错误位置的写入**

> 存储系统或磁盘控制器应该如何检测错误位置的写入？校验和需要哪些附加功能？

- 答案很简单：在**每个校验和中添加更多信息**。在这种情况下，添加物理标识符（Physical Identifier，物理 ID）非常有用



## 丢失的写入

**关键问题：如何处理丢失的写入**

> 存储系统或磁盘控制器应如何检测丢失的写入？校验和需要哪些附加功能？

- 执行写入验证（write verify），或写入后读取.。通过在写入后立即读回数据，系统可以确保数据确实到达磁盘表面.这种方法**非常慢**，使完成写入所需的 I/O 数量**翻了一番**



## 擦净

针对**未经检查的数据**对于可靠的存储系统来说是个问题，因为数据位衰减最终可能会影响特定数据的所有副本

- 许多系统利用各种形式的磁盘**擦净**
- 通过定期读取系统的每个块，并检查校验和是否仍然有效，磁盘系统可以减少某个数据项的所有副本都被破坏的可能



## 校验和的开销

- 磁盘本身
- 空间开销来自系统内存