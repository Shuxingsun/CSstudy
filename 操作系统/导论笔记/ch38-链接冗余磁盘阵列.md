# 廉价冗余磁盘阵列（RAID）

**关键问题：如何得到大型、快速、可靠的磁盘**

> 我们如何构建一个大型、快速和可靠的存储系统？关键技术是什么？不同方法之间的折中是什么？

**RAID:**这种技术使用多个磁盘一起构建更快、更大、更可靠的磁盘系统

- RAID 看起来像一个磁盘：一组可以读取或写入的块
- RAID 具有许多优点：
  - 性能：并行使用多个磁盘可以大大加快 I/O 时间
  - 容量：大型数据集需要大型磁盘
  - 可靠性：在多个磁盘上传输数据（无 RAID 技术）会使数据容易受到单个磁盘丢失的影响。通过某种形式的冗余（redundancy），RAID 可以容许损失一个磁盘并保持运行，就像没有错误一样
- RAID 为使用它们的系统透明地(transparently）提供了这些优势，即RAID 对于主机系统看起来就像一个大磁盘

**RAID的重要内容：**

- 接口
- 故障模型
- 容量
- 可靠性

- 性能



## 接口和RAID内部

- 当<u>文件系统向 RAID 发出逻辑 I/O 请求</u>时，RAID 内部必须计算要访问的磁盘（或多个磁盘）以完成请求，然后发出一个或多个物理 I/O 来执行此操作。
- RAID 系统通常构建为单独的硬件盒，并通过标准连接(SCSI或SATA)连接主机



## 故障模型

**故障—停止（fail-stop）故障模型：**两种状态

- 工作状态或故障状态
- 使用工作状态的磁盘时，所有块都可以读取或写入。相反，当磁盘出现故障时，我们认为它永久丢失。

- 故障检测假定：具体来说，当磁盘发生故障时，我们认为这很容易检测到。



## 如何评估RAID

**三指标：**

- 容量：在给定一组 N 个磁盘的情况下，RAID 的客户端可用的容量有多少？没有冗余，答案显然是N
- 可靠性：给定设计允许有多少磁盘故障？根据我们的故障模型，我们只假设整个磁盘可能会故障
- 性能：性能有点难以评估，因为它在很大程度上取决于磁盘阵列提供的工作负载

**三个RAID重要设计：RAID 0 级（条带化），RAID 1 级（镜像）和 `RAID4/5` 级（基于奇偶校验的冗余）。**



## RAID 0 级：条带化

**条带化**:系统的磁盘上将块条带化

简单条带化：

| 磁盘0 | 磁盘1 | 磁盘2 | 磁盘3 |
| ----- | ----- | ----- | ----- |
| 0     | 1     | 2     | 3     |
| 4     | 5     | 6     | 7     |
| 8     | 9     | 10    | 11    |
| 12    | 13    | 14    | 15    |

使用较大的大块大小进行条带化：

| 磁盘0 | 磁盘1 | 磁盘2 | 磁盘3 |          |
| ----- | ----- | ----- | ----- | -------- |
| 0     | 2     | 4     | 6     | 大块大小 |
| 1     | 3     | 5     | 7     | 2        |
| 8     | 10    | 12    | 14    |          |
| 9     | 11    | 13    | 15    |          |

#### **大块大小**

- 大块大小主要影响阵列的性能
- 较大的大块大小减少了这种文件内的并行性，因此依靠多个并发请求来实现高吞吐量

#### 回到RAID-0分析

- 容量：它是顶级的：给定 *N* 个磁盘，条件化提供 *N* 个磁盘的有用容量
- 可靠性：条带化也是顶级的，但是最糟糕：任何磁盘故障都会导致数据丢失
- 性能非常好：通常并行使用所有磁盘来为用户 I/O 请求提供服务。

#### 评估RAID性能

**两种不同的性能指标：**

- 单请求延迟
- RAID的稳态吞吐量(许多并发请求的总带宽)



## RAID 1级：镜像

对于镜像系统，我们只需生成系统中**每个块的多个副本**

简单RAID-1：镜像

| 磁盘0 | 磁盘1 | 磁盘2 | 磁盘3 |
| ----- | ----- | ----- | ----- |
| 0     | 0     | 1     | 1     |
| 2     | 2     | 3     | 3     |
| 4     | 4     | 5     | 5     |
| 6     | 6     | 7     | 7     |

- **读取块**时，可以读取任一副本
- **写入块**时，RAID必须更新两个副本的数据，以保证可靠性

#### RAID-1分析

- 从容量的角度来看，RAID-1 价格昂贵
- 可靠性的角度来看，RAID-1 表现良好。它可以容许任意一个磁盘的故障
- 性能：从单个读取请求的延迟角度来看，我们可以看到它与单个磁盘上的延迟相同。写入有点不同：在完成写入之前，需要完成两次物理写入。这两个写入并行发生，因此时间大致等于单次写入的时间

## RAID-4级：通过奇偶检验节省空间

基于**奇偶校验的方法试图使用较少的容量**，从而克服由镜像系统付出的巨大空间损失。

**代价：性能**

具有奇偶校验的RAID-4

| 磁盘0 | 磁盘1 | 磁盘2 | 磁盘3 | 磁盘4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 1     | 2     | 3     | P0    |
| 4     | 5     | 6     | 7     | P1    |
| 8     | 9     | 10    | 11    | P2    |
| 12    | 13    | 14    | 15    | P3    |

使用异或函数

| C0   | C1   | C2   | C3   | P                |
| ---- | ---- | ---- | ---- | ---------------- |
| 0    | 0    | 1    | 1    | XOR(0,0,1,1) = 0 |
| 0    | 1    | 0    | 0    | XOR(0,1,0,0) = 1 |

#### RAID-4分析

- 容量：RAID-4 使用 1 个磁盘作为它所保护的每组磁盘的奇偶校验信息。因此，RAID 组的有用容量是（*N*−1）。
- 可靠性：RAID-4 容许 1 个磁盘故障，不容许更多。如果丢失多个磁盘，则无法重建丢失的数据
- 性能：



## RAID-5:旋转奇偶校验

工作原理与RAID-4相似，但只是它将**奇偶校验块跨驱动器旋转**

RAID-5:

| 磁盘0 | 磁盘1 | 磁盘2 | 磁盘3 | 磁盘4 |
| ----- | ----- | ----- | ----- | ----- |
| 0     | 1     | 2     | 3     | P0    |
| 5     | 6     | 7     | P1    | 4     |
| 10    | 11    | P2    | 8     | 9     |
| 15    | P3    | 12    | 13    | 14    |
| P4    | 16    | 17    | 18    | 19    |

#### RAID-5分析

- RAID-5 的大部分分析与 RAID-4 相同
- 随机读取性能稍好一点，因为我们可以利用所有的磁盘
- 于 RAID-5 基本上与 RAID-4 相同，只是在少数情况下它更好，所以它几乎完全取代了市场上的 RAID-4。唯一没有取代的地方是系统知道自己绝不会执行大写入以外的任何事情，从而完全避免了小写入问题。

