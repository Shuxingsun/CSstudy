# I/O设备

**关键问题：如何将I/O集成计算机系统中**

> I/O 应该如何集成进系统中？其中的一般机制是什么？如何让它们变得高效？



## 系统架构

- CPU 通过某种内存总线（memory bus）或互连电缆连接到系统内存
- 图像或者其他高性能 I/O 设备通过常规的I/O 总线（I/O bus）连接到系统。
- 更下面是外围总线（peripheral bus），比如 SCSI、SATA 或者 USB。它们将最慢的设备连接到系统，包括磁盘、鼠标及其他类似设备。

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-13_22-48-10.png)

- **采用原理：因为物理布局及造价成本**
  - 越快的总线越短，因此高性能的内存总线没有足够的空间连接太多设备
  - 在工程上高性能总线的造价非常高
  - 这种分层的方式，这样可以让要求高性能的设备（比如显卡）离 CPU 更近一些，低性能的设备离 CPU 远一些



## 标准设备

- 硬件接口部分（寄存器）
- 内部结构

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-13_22-50-40.png)



## 标准协议

**通过读写这些寄存器，操作系统可以控制设备的行为。操作系统与设备交互用到的协议**

1. 操作系统通过反复读取状态寄存器
2. 操作系统下发数据到数据寄存器
3. 操作系统将命令写入寄存器
4. 通过不断轮询设备，等待并判断设备是否执行完成命令

**问题：轮询过程比较低效**。在等待设备执行完成命令时浪费大量 CPU 时间，如果此时操作系统可以切换执行下一个就绪进程，就可以大大提高 CPU 的利用率。

**关键问题：如何减少轮询开销**

> 操作系统检查设备状态时如何避免频繁轮询，从而降低管理设备的 CPU 开销？



## 利用中断减少CPU开销

**中断处理程序：**<u>是一小段操作系统代码</u>，它会结束之前的请求（比如从设备读取到了数据或者错误码）并且唤醒等待 I/O 的进程继续执行。

**中断允许计算与I/O重叠**，提高CPU关键。

- 进程 1 在 CPU 上运行一段时间（对应 CPU 那一行上重复的 1），然后发出一个读取数据的 I/O 请求给磁盘。
- 如果没有中断，那么操作系统就会简单自旋，不断轮询设备状态，直到设备完成 I/O 操作
- 当设备完成请求的操作后，进程 1 又可以继续运行。
- 利用中断并允许重叠，操作系统就可以在**等待磁盘操作时做其他事情**。P阶段可以运行其他进程

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-13_22-58-11.png)



**中断并非最佳方案**。

- 如果设备非常快，那么最好的办法反而是轮询
- 设备比较慢，那么采用允许发生重叠的中断更好



## 利用DMA进行更高效的数据传送

**关键问题：如何减少PIO的开销**

> 使用 PIO 的方式，CPU 的时间会浪费在向设备传输数据或从设备传出数据的过程中。如何才能分离这项工作，从而提高 CPU 的利用率

**使用 DMA（Direct Memory Access）:**它可以协调完成内存和设备间的数据传递，不需要 CPU 介入

- 数据的拷贝工作都是由 DMA 控制器来完成的
- 因为 CPU 在此时是空闲的，所以操作系统可以让它做一些其他事情

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-13_23-01-55.png)



## 设备交互的方法

**两种实现设备交互**

- 就是用明确的 I/O 指令
- 内存映射 I/O。通过这种方式，硬件将设备寄存器作为内存地址提供



## 纳入操作系统：设备驱动程序

**关键问题：如何实现一个设备无关的操作系统**

> 如何保持操作系统的大部分与设备无关，从而对操作系统的主要子系统隐藏设备交互的细节

**设备驱动程序：**分软件清楚地知道设备如何工作。有设备交互的细节都封装在其中

- 文件系统（当然也包括在其之上的应用程序）完全不清楚它使用的是什么类型的磁盘。它只需要简单地向通用块设备层发送读写请求即可
- 块设备层会将这些请求路由给对应的设备驱动，然后设备驱动来完成真正的底层操作

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-13_23-05-20.png)



## 小结

- 两种技术。中断和 DMA，用于提高设备效率
- 访问设备寄存器的两种方式
- 设备驱动程序的概念，展示了操作系统本身如何封装底层细节，从而更容易以设备无关的方式构建操作系统的其余部分



