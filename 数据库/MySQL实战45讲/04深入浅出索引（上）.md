# 深入浅出索引（上）

**索引的出现其实就是为了提高数据查询的效率，就像书的目录一样**

## 索引的常见类型

**哈希表、有序数组和搜索树**

- 哈希表
  - 哈希的思路很简单，把值放在数组里，用一个哈希函数把key换算成一个确定的位置，然后把value放在数组的这个位置。
  - 链表处理同一个值的情况。
    - 身份证，姓名查找。（先查找姓名，在顺序遍历查找身份证）首先，将ID_card_n2通过哈希函 数算出N；然后，按顺序遍历，找到User2。
    - ![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-02_12-21-40.png)
  - 哈希值不是递增的。**哈希索引作区间查询慢**
  - **适用于等值查询。**比如`Memcached`及其他一些`NoSQL`引擎
- 有序数组
  - **在等值查询和范围查询性能优秀**
  - 二分法查找，时间复杂度为O(log(N))
  - 有序数组只适用于**静态存储引擎**。比如你要保存的是2017年某个城市的所有人口 信息，这类不会再修改的数据
  - ![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-02_12-26-24.png)
- 二叉搜索树
  - 特点：节点左儿子<父节点<右儿子。时间复杂度：O(log(N))
  - ![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-02_12-27-46.png)

- N叉数
  - 让一个查询**尽量少地读磁盘**，就必须让**查询过程访问尽量少的数据块**
  - “N叉”树中的“N”取决于数据块的大小

## 实战

索引是在存储引擎层实现的，所以并没有统一的索引标准，即**不同存储引擎的索引的工作方式并不一样**。即使多个存储引擎支持同一种类型的索引，其底层的实现也可能不同。

### InnoDB存储引擎

InnoDB存储引擎在MySQL数据库中使用最为广泛。**实战以InnoDB为例**

- 在InnoDB中，表都是根据主键顺序以索引的形式存放的，这种存储方式的表称为**索引组织表**
- InnoDB使用了**B+树索引模型**，所以数据都是存储在B+树中。

```mysql
mysql> create table T( id int primary key, k int not null, name varchar(16), index (k))engine=InnoDB;
```

插入值：表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)

![](https://picture-house.oss-cn-beijing.aliyuncs.com/notes/2022-04-02_12-45-16.png)

**主键索引的叶子节点存的是整行数据**

**非主键索引的叶子节点内容是主键的值**

- 基于主键索引和普通索引的区别：
  - 如果语句是select *fromTwhere ID=500，即主键查询方式，则只需要搜索ID这棵B+树； 
  - 如果语句是select *fromTwhere k=5，即普通索引查询方式，则需要先搜索k索引树，得到ID 的值为500，再到ID索引树搜索一次。这个过程称为**回表**

- 索引维护

  - B+树为了维护索引有序性，在插入新值的时候需要做必要的维护
  - 如果R5所在的数据页已经满了，根据B+树的算法，这时候需要申请一个新的 数据页，然后挪动部分数据过去。这个过程称为页分裂
  - 页分裂：性能受影响；影响数据页的利用率
  - 页合并：当相邻两个页由于删除了数据，利用率很低之后，会将数据页做合并。

- 哪些场景使用自增主键

  - 建表语句定义：

    ```mysql
    NOTNULL PRIMARY KEY AUTO_INCREMENT。
     
    ```

  - 插入新记录的时候可以不指定ID的值，系统会获取当前ID最大值加1作为下一条记录的ID值。

  - 自增主键的插入数据模式，正符合了我们前面提到的递增插入的场景。每次插入一条 新记录，都是追加操作，都不涉及到挪动其他记录，也不会触发叶子节点的分裂

  - **主键长度越小，普通索引的叶子节点越小，占用空间越小**

  - 从性能和存储空间方面考量，自增主键往往是更合理的选择。

  - 适应的业务场景——**KV场景**

    - 只有一个索引
    - 该索引必须时唯一索引



